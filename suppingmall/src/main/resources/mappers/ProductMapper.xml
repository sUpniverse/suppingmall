<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.supshop.suppingmall.mapper.ProductMapper">
    <resultMap id="product" type="com.supshop.suppingmall.product.Product" autoMapping="true">
        <id property="productId" column="ProductNo" />
        <result property="name" column="ProductName" />
        <result property="price" column="ProductPrice" />
        <result property="registeredDate" column="ProductRegisteredDate" />
        <result property="delYn" column="ProductDelYn"/>
        <result property="thumbnail" column="ProductThumbnail" />
        <result property="picture" column="ProductPicture" />
        <association property="detail" column="ProductId" javaType="com.supshop.suppingmall.product.ProductDetail">
            <id property="id" column="ProductDetailId" />
            <result property="asNumber" column="ProductAsNumber"/>
            <result property="manuplatedDate" column="ProductManuplatedDate"/>
            <result property="manufacturer" column="ProductManufacturer"/>
            <result property="orgin" column="ProductOrigin"/>
            <result property="spec1" column="ProductSpec1" />
            <result property="spec2" column="ProductSpec2" />
            <result property="spec3" column="ProductSpec3" />
            <result property="spec4" column="ProductSpec4" />
            <result property="spec5" column="ProductSpec5" />
        </association>
        <association property="seller" javaType="com.supshop.suppingmall.user.User">
            <id property="userId" column="UserId" />
            <result property="email" column="UserEmail" />
            <result property="nickName" column="UserNickName" />
            <result property="createdDate" column="UserCreatedDate" />
            <result property="role" column="UserRole" typeHandler="com.supshop.suppingmall.user.RoleTypeHandler" />
            <result property="shop_name" column="UserShopName" />
            <result property="shop_number" column="UserShopNumber" />
            <result property="shop_city" column="UserShopCity" />
            <result property="shop_city_detail" column="UserShopCityDetail" />
            <result property="shop_zipcode" column="UserShopZipCode" />
        </association>
        <association property="category" javaType="com.supshop.suppingmall.category.Category">
            <id property="id" column="CategoryId" />
            <result property="name" column="CategoryName" />
        </association>
        <collection property="options" column="ProductId" ofType="com.supshop.suppingmall.product.ProductOption" >
            <id property="id" column="ProductOptionId" />
            <result property="optionName" column="ProductOptionName" />
            <result property="price" column="ProductOptionPrice" />
            <result property="quantity" column="ProductOptionQuantity" />
        </collection>
    </resultMap>

    <select id="selectAllProduct" resultMap="product" >
        SELECT P.product_id AS "ProductId", P.name AS "ProductName", P.price AS "ProductPrice",
        P.registered_date AS "ProductRegisteredDate", P.seller_id AS "ProductSellerId", P.category_id AS "ProductCategory",
        P.thumbnail AS "ProductThumbnail", P.picture AS "ProductPicture",
        PD.product_detail_id AS "ProductDetailId", PD.as_number AS "ProductAsNumber", PD.manuplated_date AS "PrdouctManuplatedDate",
        PD.contry_of_origin AS "ProductOrigin", PD.manufacturer AS "ProductManufacturer", PD.spec_1 AS "ProductSpec1",
        PD.spec_2 AS "ProductSpec2",PD.spec_3 AS "ProductSpec3", PD.spec_4 AS "ProductSpec4", PD.spec_5 AS "ProductSpec5",
        PO.product_option_id AS "ProductOptionId", PO.name AS "ProductOptionName", PO.quantity AS "ProductOptionQuantity",
        C.category_id AS "CategoryId", C.name AS "CategoryName"
        FROM Product AS P
        LEFT OUTER JOIN Product_Detail AS PD on (P.product_id = PD.product_id)
        LEFT OUTER JOIN Product_Option AS PO on (P.product_id = PO.product_id)
        LEFT OUTER JOIN category AS C on (p.category_id = C.category_id)
<!--        <include refid="conditionalSearch"></include>-->
        ORDER BY P.product_id, PO.product_option_id, PD.product_detail_id ASC
    </select>

    <sql id="conditionalSearch">
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="id != null">
                AND P.product_id = #{id}
            </if>
            <if test="category != null">
                AND P.category_id = #{category.id}
            </if>
            <if test="name != null">
                <bind name="name" value="'%'+name+'%'"/>
                AND P.name LIKE #{name}
            </if>
            WHERE P.product_id = #{id} AND P.delYn = 'Y'
        </trim>
    </sql>

    <select id="selectProduct" resultMap="product" >
        SELECT P.product_id AS "ProductId", P.name AS "ProductName", P.price AS "ProductPrice",
        P.registered_date AS "ProductRegisteredDate", P.seller_id AS "ProductSellerId", P.category_id AS "ProductCategory",
        P.thumbnail AS "ProductThumbnail", P.picture AS "ProductPicture",
        PD.product_detail_id AS "ProductDetailId", PD.as_number AS "ProductAsNumber", PD.manuplated_date AS "PrdouctManuplatedDate",
        PD.contry_of_origin AS "ProductOrigin", PD.manufacturer AS "ProductManufacturer", PD.spec_1 AS "ProductSpec1",
        PD.spec_2 AS "ProductSpec2",PD.spec_3 AS "ProductSpec3", PD.spec_4 AS "ProductSpec4", PD.spec_5 AS "ProductSpec5",
        PO.product_option_id AS "ProductOptionId", PO.name AS "ProductOptionName", PO.quantity AS "ProductOptionQuantity",
        C.category_id AS "CategoryId", C.name AS "CategoryName"
        FROM Product AS P
        LEFT OUTER JOIN Product_Detail AS PD on (P.product_id = PD.product_id)
        LEFT OUTER JOIN Product_Option AS PO on (P.product_id = PO.product_id)
        LEFT OUTER JOIN category AS C on (p.category_id = C.category_id)
        WHERE P.product_id = #{id} AND P.delYn = 'N'
        ORDER BY P.product_id, PO.product_option_id, user_id ASC
    </select>

    <sql id="addProductOptions">
        <if test="options != null and options.size > 0">
            <foreach collection="options" item="option" index="index" separator=";">
                INSERT INTO Product_Option(
                product_option_id,
                name,
                price,
                quantity)
                VALUES (
                #{option.id},
                #{option.name},
                #{option.price},
                #{option.quantity})
            </foreach>
        </if>
    </sql>

    <sql id="addProductDetail">
        <if test="detail != null and detail.size > 0">
            INSERT INTO Product_Detail(
            product_detail_id,
            as_number,
            manuplated_date,
            manufacturer,
            contry_of_origin,
            spec_1,
            spec_2,
            spec_3,
            spec_4,
            spec_5,
            spec_6
--             spec_7,
--             spec_8,
--             spec_9,
--             spec_10
            )
            VALUES (
            '1',
            #{detail.asNumber},
            #{detail.manuplatedDate},
            #{detail.manufacturer},
            #{detail.origin},
            #{detail.spec2},
            #{detail.spec3},
            #{detail.spec4},
            #{detail.spec5},
            #{detail.spec6}
--             #{detail.spec7},
--             #{detail.spec8},
--             #{detail.spec9},
--             #{detail.spec10}
            )
        </if>
    </sql>

    <insert id="insertProduct" parameterType="com.supshop.suppingmall.product.Product" keyProperty="id">
        INSERT INTO Product(
                product_id,
                name,
                price,
                registered_date,
                seller_id,
                category_id,
                delYn,
                thumbnail,
                picture)
                VALUES (
                #{id},
                #{name},
                #{registeredDate},
                #{seller.userId},
                #{category.id},
                'N',
                #{thumbnail},
                #{picture})
        <include refid="addProductOptions" />
        <include refid="addProductDetail" />
    </insert>

    <update id="deleteProduct" parameterType="com.supshop.suppingmall.product.Product">
        UPDATE Product
        SET
        delYn = 'Y',
        WHERE product_id = #{id}
    </update>

</mapper>
