<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:include="fragments/header :: header" />
    <link rel="stylesheet" th:href="@{/css/jquery.treeview.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/dashboard.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/readonly.css}" />
    <script th:src="@{/js/jquery.treeview.js}" type="text/javascript"></script>
    <script type="text/javascript">
        $(function() {
            $("#tree").treeview({
                collapsed: true,
                animated: "medium",
                control:"#sidetreecontrol",
                persist: "location"
            });
        })
    </script>
</head>
<body>
<div th:replace="fragments/navigation-fix :: navigation-fix" />
<div class="container-fluid">
    <div class="row">
        <nav th:replace="user/admin/admin-left-bar :: admin-left-bar" />
        <div class="col-md-6 ml-sm-auto col-lg-8 pl-5 pt-5">
            <div>
                <h3>카테고리 관리</h3>
            </div>
            <div class="row mt-5">
                <div class="col-md-5">
                    <h5>카테고리 분류</h5>
                    <div class="bg-secondary">
                        <button class="my-3 ml-3" id="add">카테고리 추가</button>
                        <button class="my-3">
                            <span class="text-danger">x</span>
                            삭제
                        </button>
                    </div>
                    <div class="border">
                        <ul id="tree" class="treeview">
                            <li th:class="${not #arrays.isEmpty(category.getChild())} ? 'expandable' : ''" th:each="category : ${categories}">
                                <div class="hitarea expandable-hitarea" th:if="${not #arrays.isEmpty(category.getChild())}"></div>
                                <a href="#" th:id="${category.id}" th:text="${category.name}"></a>
                                <ul style="display: none;" th:if="${not #arrays.isEmpty(category.getChild())}">
                                    <li th:each="child : ${category.getChild()}">
                                        <div class="hitarea expandable-hitarea"></div>
                                        <a href="#" th:text="${child.name}" th:id="${child.id}"></a>
                                        <ul style="display: none"></ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-5 ml-sm-3">
                    <h5>카테고리 상세</h5>
                    <form role="form">
                        <input type="hidden" th:id="id">
                        <table class="table table-default">
                            <tr>
                                <th>카테고리 이름</th>
                                <td th:id="name"></td>
                            </tr>
                            <tr>
                                <th>카테고리 설명</th>
                                <td th:id="memo"></td>
                            </tr>
                        </table>
                    </form>
                    <div class="text-center">
                        <button class="btn btn-warning">변경하기</button>
                    </div>
                </div>
            </div>
            <div class="mt-5">
                <form id="addCategoryForm" style="display: none">
                    <table class="table table-default">
                        <tr>
                            <th>상위 카테고리</th>
                            <td class="form-row">
                                <div class="col">
                                    <select class="form-control" th:id="category_top">
                                        <option th:value="0" selected>선택하세요</option>
                                        <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                                    </select>
                                </div>
                                <div class="col">
                                    <select class="form-control mx-3" th:id="category_middle">
                                        <option th:value="0" selected>선택하세요</option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>카테고리명</th>
                            <td>
                                <input th:id="addCategoryName" class="form-control" th:name="name">
                            </td>
                            <th>카테고리 메모</th>
                            <td>
                                <input th:id="addCategoryMemo" class="form-control" th:name="memo">
                            </td>
                        </tr>
                    </table>
                    <div th:class="form-inline">
                        <input type="button" th:class="form-control" th:id="addCategoryBtn" value="추가">
                        <input type="button" th:class="form-control" th:id="addCategoryCancelBtn" value="취소">
                    </div>
                </form>
            </div>
        </div>
        <div class="col-md-2">
            여기도 광고?
        </div>
    </div>
</div>
</body>
<footer th:include="fragments/footer :: footer" />
<script th:inline="javascript" th:src="@{/js/getCategoryByOnClick.js}"></script>
<script th:inline="javascript" th:src="@{/js/getCategoryBySelectedOption.js}"></script>
<script th:inline="javascript">

    $(document).on("click",".btn-warning",function() {
        document.getElementById('name').innerText
    });

    $(document).on("click",'#add',function() {
        document.getElementById("addCategoryForm").style.display = 'block';
    });

    $(document).on("click",'#addCategoryBtn',function () {

        var parentId = 0;
        var name = "";
        var memo = "";

        var category = {
            parent : {
                id: parentId
            },
            name : name,
            memo : memo
        };

        var middle_id = $("#category_middle option:selected").val();

        if(middle_id === 0) {
            var top_id = $("#category_top option:selected").val();
            if(top_id === 0) {
                alert("카테고리를 선택해주세요");
                return;
            }
            category.parent.id = top_id;
        } else {
            category.parent.id = middle_id;
        }
        category.name  = document.getElementById('addCategoryName').value;
        category.memo = document.getElementById('addCategoryMemo').value;

        addCategory(category);

    });

    $(document).on("click",'#addCategoryCancelBtn',function () {
        document.getElementById('category_top').val(0).prop('selected',true);
        document.getElementById('addCategoryName').textContent = "";
        document.getElementById('addCategoryMemo').textContent = "";
        document.getElementById("addCategoryForm").style.display = 'none';
    });

    function addCategory(category) {

        $.ajax({
            type:"POST",
            url:"/category",
            contentType: 'application/json',
            data : JSON.stringify(category),
            success: (data,status,xhr) => {
                var url = xhr.getResponseHeader("Location");
                var id = url.split("/")[4];
                addNewCategoryInList(id,category);

            },
            error: () => {
                alert('카테고리를 가져올 수 없습니다.');
            }
        });

    }

    function addNewCategoryInList(categoryId, category) {
        var option = '<li class="expandable">' +
                     '<a href="#" id="'+categoryId+'" class="">'+category.name+'</a>' +
                     '</li>';
        document.getElementById(category.parent.id).nextSibling.nextSibling.innerHTML  = option;
        document.getElementById('addCategoryName').textContent = "";
        document.getElementById('addCategoryMemo').textContent = "";
        document.getElementById("addCategoryForm").style.display = 'none';
    }

    function isEmpty(str) {
        if(typeof str === "undefined" || str === null || str === "")
            return true;
        else
            return false;
    }


</script>
<script th:inline="javascript">

    $(document).on('click','li.expandable > div',function (e) {
        var parentId = e.target.nextSibling.nextSibling.getAttribute('id');
        if(parentId === null) {
            parentId = e.target.nextSibling.getAttribute('id');
        }
        if(isEmpty(document.getElementById(parentId).parentElement.getElementsByTagName("ul")[0].innerHTML)) {
            getChildCategory(parentId);
        }

    });

    function getChildCategory(parentId) {

        $.ajax({
            type:"GET",
            url:"/category/"+parentId+'/children',
            contentType: 'application/json',
            success: (data,status,xhr) => {
                addCategoryInList(parentId,data);
            },
            error: () => {
                alert('카테고리를 가져올 수 없습니다.');
            }
        });
    }

    function addCategoryInList(parentId,child) {
        child.forEach(category => {
            var option ="";
            console.log(category);
            if(category.child.length === 0) {
                option+='<li>' +
                        '<a href="#" id="'+category.id+'">'+category.name+'</a>' +
                        '</li>';
            } else {
                option+= '<li class="expandable">' +
                            '<div class="hitarea expandable-hitarea"></div>' +
                            '<a href="#" id="'+category.id+'">'+category.name+'</a>' +
                            '<ul style="display: none;"></ul>' +
                         '</li>';
            }
            // document.getElementById(parentId).parentElement.getElementsByTagName("ul")[0].innerHTML += option;
            document.getElementById(parentId).parentElement.getElementsByTagName("ul")[0].insertAdjacentHTML('beforeend',option);
        });
    }

</script>
</html>