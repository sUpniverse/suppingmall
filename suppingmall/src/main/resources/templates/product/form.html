<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head>
        <div th:include="fragments/header :: header" />

        <script src="https://cdn.ckeditor.com/ckeditor5/15.0.0/classic/ckeditor.js"></script>
        <style>
            .ck.ck-editor__editable {
                min-height: 300px;
            }

        </style>
    </head>
    <body>
        <nav th:replace="fragments/navigation :: navigation" />
        <div class="container">
            <div class="py-1 mb-5 text-center">
                <img class="d-block mx-auto mb-4" src="/docs/4.3/assets/brand/bootstrap-solid.svg" alt="" width="72" height="72">
                <h2>물품 등록</h2>
            </div>

            <div class="col-md order-md-1">
                <h4 class="mb-3">물품 기본정보 입력</h4>
                <form class="needs-validation" th:action="@{/products}" th:method="post" enctype="multipart/form-data">
                    <input th:type="hidden" th:name="seller.userId" th:value="${session.user.userId}" >
                    <div class="row" >
                        <div class="form-group col-md-6 mb-3">
                            <label for="product_category_top">카테고리 분류 1차</label>
                            <select class="form-control" id="product_category_top" required>
                                <option disabled selected value> -- select an option -- </option>
                                <option th:each="category : ${categories}" th:id="category_parent" th:value="${category.id}" th:text="${category.name}"></option>
                            </select>
                        </div>
                        <div class="form-group col-md-6 mb-3">
                            <label for="product_category_bottom">카테고리 분류 2차</label>
                            <select class="form-control" id="product_category_bottom" th:name="category.id" >
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_name">상품명</label>
                            <input type="text" class="form-control" id="product_name" th:name="name" required>
                            <small class="text-muted">Full name as displayed on card</small>
                            <div class="invalid-feedback">
                                Name on card is required
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="price">가격 <span class="text-muted">(원)</span></label></label>
                            <input type="text" class="form-control" id="price" th:name="price" required>
                            <small class="text-muted">Full name as displayed on card</small>
                            <div class="invalid-feedback">
                                Name on card is required
                            </div>
                        </div>
                    </div>

                    <hr class="mb-4">
                    <h4 class="mb-3">물품 상세정보 입력</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_name">제조사</label>
                            <input type="text" class="form-control" id="brand_name" th:name="detail.manufacturer" required>
                            <small class="text-muted">Full name as displayed on card</small>
                            <div class="invalid-feedback">
                                Name on card is required
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_name">원산지</label>
                            <input type="text" class="form-control" id="made_in" th:name="detail.origin" required>
                            <small class="text-muted">Full name as displayed on card</small>
                            <div class="invalid-feedback">
                                Name on card is required
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_name">제조년월</label>
                            <input type="date" class="form-control" id="register_date" th:name="detail.manuplatedDate" required>
                            <small class="text-muted">Full name as displayed on card</small>
                            <div class="invalid-feedback">
                                Name on card is required
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product_name">a/s 안내</label>
                            <input type="text" class="form-control" id="as_number" th:name="detail.asNumber" required>
                            <small class="text-muted">Full name as displayed on card</small>
                            <div class="invalid-feedback">
                                Name on card is required
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="spec1">스펙1 <span class="text-muted">(제품의 상세스펙)</span></label></label>
                            <input type="text" class="form-control" id="spec1" th:name="detail.spec1">
                            <small class="text-muted">제품의 상세 스펙을 적으세요</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="spec2">스펙2 <span class="text-muted">(제품의 상세스펙)</span></label></label>
                            <input type="text" class="form-control" id="spec2" th:name="detail.spec2">
                            <small class="text-muted">제품의 상세 스펙을 적으세요</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="spec3">스펙3 <span class="text-muted">(제품의 상세스펙)</span></label></label>
                            <input type="text" class="form-control" id="spec3" th:name="detail.spec3">
                            <small class="text-muted">제품의 상세 스펙을 적으세요</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="spec4">스펙4 <span class="text-muted">(제품의 상세스펙)</span></label></label>
                            <input type="text" class="form-control" id="spec4" th:name="detail.spec4">
                            <small class="text-muted">제품의 상세 스펙을 적으세요</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="spec5">스펙5 <span class="text-muted">(제품의 상세스펙)</span></label></label>
                            <input type="text" class="form-control" id="spec5" th:name="detail.spec5">
                            <small class="text-muted">제품의 상세 스펙을 적으세요</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="spec6">스펙6 <span class="text-muted">(제품의 상세스펙)</span></label></label>
                            <input type="text" class="form-control" id="spec6" th:name="detail.spec6">
                            <small class="text-muted">제품의 상세 스펙을 적으세요</small>
                        </div>
                    </div>

                    <hr class="mb-4">
                    <h4 class="mb-3">썸네일 이미지 첨부(리스트 노출용)</h4>
                    <div>
                        <img id="thumnail_preview" src="#" th:height="200px" th:width="300px"/>
                        <br />
                        <input type="file" th:name="thumnails" accept=".gif, .jpg, .png" onchange="readURL(this)" multiple />
                    </div>

                    <hr class="mb-4">
                    <h4 class="mb-3">상품 옵션</h4>
                    <div class="mb-2">
                        <button type="button" class="btn btn-light btn-sm" onclick="addOptionListener();">+옵션 추가</button>
                        <button type="button" class="btn btn-danger btn-sm">옵션 저장</button>
                    </div>
                    <div class="container">
                        <table class="table table-bordered" th:id="option_table">
                            <thead>
                                <tr>
                                    <th>NO</th>
                                    <th>옵션명</th>
                                    <th>판매가(원)</th>
                                    <th>재고량</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="optionRow">
                                    <td><input type="text" class="form-control" th:name="options[0].optionId" th:value="1" readonly></td>
                                    <td><input type="text" class="form-control" th:name="options[0].optionName" placeholder="옵션명"></td>
                                    <td><input type="text" class="form-control" th:name="options[0].price" placeholder="추가 가격(원)"></td>
                                    <td><input type="text" class="form-control" th:name="options[0].quantity" placeholder="재고량"></td>
                                    <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteOptionListener(this);">x</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <hr class="mb-4">
                    <h4 class="mb-3">내용 입력</h4>
                    <textarea th:name="contents" id="editor"></textarea>

                    <hr class="mb-4">
                    <h4 class="mb-3">판매자 정보</h4>

                    <button class="btn btn-primary btn-lg btn-block" type="submit">상품 등록</button>
                </form>
            </div>
        </div>
        <footer th:include="fragments/footer :: footer" />
    </body>

    <script type="text/javascript">
        // 옵션 추가 스크립트
        function addOptionListener() {
            var count = $("#option_table tbody tr").length
            var order = count + 1;
            var option =
                '<tr id="optionRow">\n' +
                '<td><input type="text" class="form-control" id="option_number" name ="options['+count+'].id" value="'+order+'" readonly></td>\n' +
                '<td><input type="text" class="form-control" id="option" name="options['+count+'].optionName" placeholder="옵션명"></td>\n' +
                '<td><input type="text" class="form-control" name="options['+count+'].price" placeholder="추가 가격(원)"></td>\n' +
                '<td><input type="text" class="form-control" name="options['+count+'].quantity" placeholder="수량"></td>\n' +
                '<td><button type="button" class="btn btn-danger btn-sm" onclick="deleteOptionListener(this);" ">x</button></td>\n' +
                '</tr>';

            $("#option_table tbody tr:last").after(option);
        }
        
        function deleteOptionListener(obj) {
            var tr = $(obj).parent().parent();
            tr.remove();
        }
        
    </script>
    <script>

        // smart editor 관련 설정
        var editor_id = '#editor';

        ClassicEditor
            .create( document.querySelector('#editor'), {
                language: "ko"
            })
            .then( editor => {
                editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                    return new MyUploadAdapter(loader);
                };
            })
            .catch(function (error) {
                console.log(error);
            });


        class MyUploadAdapter {

            constructor(loader) {
                this.loader = loader;
            }
            upload() {
                return this.loader.file
                    .then(file => new Promise((resolve, reject) => {
                        this._initRequest();
                        this._initListeners(resolve, reject, file);
                        this._sendRequest(file);
                    }));
            }

            abort() {
                if (this.xhr) { this.xhr.abort(); }

            }

            _initRequest() {
                const xhr = this.xhr = new XMLHttpRequest();
                xhr.open('POST', '/images/product', true);
                xhr.responseType = 'json';
            }

            _initListeners(resolve, reject, file) {
                const xhr = this.xhr;
                const loader = this.loader;
                const genericErrorText = `Couldn't upload file: ${ file.name }.`;
                xhr.addEventListener('error', () => reject(genericErrorText));
                xhr.addEventListener('abort', () => reject());
                xhr.addEventListener('load', () => {
                    const response = xhr.response;
                    if (!response || response.error) {
                        return reject(response && response.error ? response.error.message : genericErrorText);
                    }
                    resolve({
                        default: response.url
                    });
                });

                if (xhr.upload) {
                    xhr.upload.addEventListener('progress', evt => {
                        if (evt.lengthComputable) {
                            loader.uploadTotal = evt.total;
                            loader.uploaded = evt.loaded;
                        }
                    });
                }
            }

            _sendRequest(file) {
                const data = new FormData();
                data.append('file', file);
                this.xhr.send(data);
            }
        }
    </script>

    <script type="text/javascript">
        var category_bottom;
        $('#product_category_top').on('change',(e) => {
            var category_id = $("#product_category_top option:selected").val();
            $.ajax({
                type:"GET",
                url:"/categories/"+ category_id,
                contentType: 'application/json',
                success: (data) => {
                    $("#product_category_bottom option").remove();
                    var category_bottom = data;
                    console.log(data);
                    for(var i = 0; i < data.length; i++) {
                        var option = "<option value="+data[i].id+">"+data[i].name+"</option>";
                        $("#product_category_bottom").append(option);
                    }
                }
            });
        });
    </script>
    <script type="text/javascript">
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#thumnail_preview').attr('src', e.target.result);
                }
                    reader.readAsDataURL(input.files[0]);
            }
        }
    </script>


    <footer th:include="fragments/footer :: footer" />
</html>