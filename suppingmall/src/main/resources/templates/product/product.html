<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:include="fragments/header :: header" />
<body>
<nav th:replace="fragments/navigation :: navigation" />
<nav class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <ol class="breadcrumb mb-0 font-size-xs">
                    <li class="breadcrumb-item">
                        <a href="#" th:text="${product.category.parent}">
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#" th:text="${product.category.parent}">
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#" th:text="${product.category.name}">
                        </a>
                    </li>
                </ol>
            </div>
        </div>
    </div>
</nav>
<section>
    <div class="container">
    <h1 class="mt-2 font-weight-bold" th:text="${product.name}"></h1>
        <hr style="border: solid 1px">
        <div class="row">
            <div class="col-12">
                <div class="row">
                    <div class="col-12 col-md-6">
                        <img th:src="${product.thumbnail}">
                    </div>
                    <div class="col-12 col-md-6 pl-lg-10">


                        <!-- manufacturer -->
                        <div class="font-weight-bold">
                            <strong class="d-inline-block text-danger">[[${product.detail.manufacturer}]]</strong>
                        </div>
                        <hr>
                        <!-- price -->
                        <div>
                            <h4 class="mb-1 font-weight-bold text-muted">
                                [[${#numbers.formatInteger(product.price,3,'COMMA')}]]원
                            </h4>
                        </div>
                        <hr>
                        <p>
                            배송비 : 무료 | 도서산간배송비 추가
                        </p>
                        <hr>
                        <!-- origin -->
                        <div class="font-weight-bold">
                            원산지 : [[${product.detail.origin}]]
                        </div>

                        <hr>
                        <div>
                            <label for="product_options">옵션</label>
                            <select class="form-control" id="product_options" required>
                                <option disabled selected value>선택하세요</option>
                                <option th:each="option : ${product.options}" th:value="${option.price}" th:text="${option.optionName}"></option>
                            </select>
                        </div>
                        <hr>
                        <div th:id="product_composition_last">
                        </div>
                        <div th:id="total_pr" class="mb-4">

                        </div>
                        <div class="btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-outline-dark">
                                <input type="radio" name="options" id="option1"> 장바구니담기
                            </label>
                            <label class="btn btn-outline-dark">
                                <input type="radio" name="options" id="option2"> 구매하기
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<hr>
<div class="container">
    <nav class="nav nav-pills nav-justified sticky-top bg-white">
        <a class="nav-item nav-link text-dark" href="#contents">상품정보</a>
        <a class="nav-item nav-link text-dark" href="#review">상품리뷰</a>
        <a class="nav-item nav-link text-dark" href="#qna">Q&A</a>
        <a class="nav-item nav-link text-dark" href="#sellerInfo">판매자정보</a>
    </nav>
    <div th:id="contents">
        <p th:utext="${product.contents}"></p>
    </div>
    <div class="mt-5" th:id="review">
        <h4>전체리뷰</h4>
        <hr>
        <ul>
            <li>
                <p>와우 좋아요!</p>
            </li>
        </ul>
    </div>
    <div class="mt-5" th:id="qna">
        <table class="mt-3 table">
           <thead class="thead-light">
               <tr>
                   <th>문의유형</th>
                   <th>문의/답변</th>
                   <th>작성자</th>
                   <th>작성일</th>
               </tr>
           </thead>
        </table>
    </div>
    <div class="mt-5" th:id="sellerInfo">
        <h4>반품/교환 정보</h4>
        <table class="mt-3 table table">
            <tr>
                <th>
                    판매자명
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    고객문의 대표번호
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환 배송비
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환지 주소
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환 안내
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환지 기준
                </th>
                <td>

                </td>
            </tr>
        </table>
    </div>
</div>
</body>
<script>

    var optionArray = new Array();

    $(document).on('change',"#product_options",() => {

        let id = $("#product_options option").index($("#product_options option:selected"));

        if(optionArray.indexOf(id) !== -1) {
            alert('이미 선택되었습니다.');
            $("#product_options option:first").prop("selected",true);
            return;
        }
        optionArray.push(id);

        let price = $("#product_options option:selected").val();
        let name = $("#product_options option:selected").text();



        document.getElementById("product_composition_last").innerHTML +=
            '<div class="card mb-3" style="width: 30rem;" data-prdno="'+id+'">\n' +
            '  <div class="card-body">\n' +
            '    <h5 class="card-title">'+name+'</h5>\n' +
            '<div class="row">\n' +
            '<div class="col-4">\n' +
            '<div class="btn-group" role="group" aria-label="Basic example">\n' +
            '  <button type="button" class="btn btn-outline-dark btn-sm" id="subtractOption">-</button>\n' +
            '  <button type="button" class="btn btn-outline-dark btn-sm">1</button>\n' +
            '  <button type="button" class="btn btn-outline-dark btn-sm" id="plusOption">+</button>\n' +
            '</div>\n' +
            '</div>\n' +
            '<div class="col-7">\n' +
            '    <p class="card-text text-right"><strong>'+price+'</strong>원</p>\n' +
            '</div>\n' +
            '<div class="col-1">\n' +
            ' <button type="button" class="btn btn-secondary btn-sm" id="cancelProduct">x</button>\n' +
            '</div>\n' +
            '  </div>\n' +
            '</div>';


        $("#product_options option:first").prop("selected",true);
        getSumPrice(price);

    });




    function getSumPrice(price) {
        var pricePrint = document.getElementById("total_pr");
        var parsePrcie = parseInt(price);
        if(!document.getElementById("total_price")) {
            pricePrint.innerHTML =
                '<hr>\n' +
                '<div class="row justify-content-between" id="total_price">\n' +
                '<strong class="col-4">총 합계 금액</strong>\n' +
                '<span class="col-4 row">\n' +
                '<h4 class="text-danger" id="ui_total_price">'+parsePrcie+'</h4>\n' +
                '원\n' +
                '</span>\n' +
                '</div>\n' +
                '<hr>';
        } else {
            var prePrice = parseInt(document.getElementById("ui_total_price").textContent);
            document.getElementById("ui_total_price").textContent = prePrice + parsePrcie;
        }
    }

    function changeButtonValue(e,fuc) {
        var button = e.target;
        var valueButton = button.parentElement.childNodes[3];
        var value = parseInt(valueButton.textContent);


        priceText = button.parentElement.parentElement.nextElementSibling.getElementsByTagName('strong').item(0);
        var price = parseInt(priceText.textContent);

        var eachPrice = price / (value);

        if(fuc === "sub") {
            if( value > 1) {
                valueButton.textContent = value - 1;
                priceText.textContent = eachPrice * (value-1);
                getSumPrice(eachPrice * -1);
            }
        } else if (fuc === "add") {
            valueButton.textContent = value + 1;
            priceText.textContent = eachPrice * (value+1);
            getSumPrice(eachPrice);
        }

    }


    $(document).on('click',"#subtractOption",(e) => {
        changeButtonValue(e,"sub");

    });

    $(document).on('click',"#plusOption",(e) => {
        changeButtonValue(e,"add");
    });

    $(document).on('click',"#cancelProduct",(e) =>{
        var button = e.target;
        var parent = button.parentElement.parentElement.parentElement.parentElement;
        var parentId = parseInt(parent.getAttribute('data-prdno'));
        parent.remove();
        getSumPrice(parseInt(button.parentElement.parentElement.getElementsByTagName("strong").item(0).textContent) * -1);
        var number = optionArray.indexOf(parentId);
        optionArray.splice(number,1);

        if(optionArray.length === 0) {
            document.getElementById("total_pr").remove();
        }
    })



</script>
</html>