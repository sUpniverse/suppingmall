<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:include="fragments/header :: header" />
<head>
    <style>
        ul{
            list-style:none;
            padding: unset;
        }
    </style>
</head>
<body>
<div class="container">
    <header th:replace="product/product-nav :: product-nav" />
    <nav th:replace="product/product-search :: product-search" />
</div>
<nav class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <ol class="breadcrumb mb-0 font-size-xs">
                    <li class="breadcrumb-item">
                        <a href="#" th:text="${product.category.parent}">
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#" th:text="${product.category.parent}">
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#" th:text="${product.category.name}">
                        </a>
                    </li>
                </ol>
            </div>
        </div>
    </div>
</nav>
<section>
    <div class="container">
    <h1 class="mt-2 font-weight-bold" th:text="${product.name}"></h1>
        <hr style="border: solid 1px">
        <div class="row">
            <div class="col-12">
                <div class="row">
                    <div class="col-12 col-md-6">
                        <img th:src="${product.thumbnail}">
                    </div>
                    <div class="col-12 col-md-6 pl-lg-10">
                        <form role="form">
                            <input type="hidden" name="productId" th:value="${product.productId}">
                            <input type="hidden" name="orderItems" id="orderItemJson">
                            <!-- manufacturer -->
                            <div class="font-weight-bold">
                                <strong class="d-inline-block text-danger">[[${product.detail.manufacturer}]]</strong>
                            </div>
                            <hr>
                            <!-- price -->
                            <div>
                                <h4 class="mb-1 font-weight-bold text-muted">
                                    [[${#numbers.formatInteger(product.price,3,'COMMA')}]]원
                                </h4>
                            </div>
                            <hr>
                            <p>
                                배송비 : 무료 | 도서산간배송비 추가
                            </p>
                            <hr>
                            <!-- origin -->
                            <div class="font-weight-bold">
                                원산지 : [[${product.detail.origin}]]
                            </div>

                            <hr>
                            <div>
                                <label for="product_options">옵션</label>
                                <select class="form-control" id="product_options" required>
                                    <option disabled selected value>선택하세요</option>
                                    <option th:each="option : ${product.options}" th:value="${option.price}" th:text="${option.optionName}"></option>
                                </select>
                            </div>
                            <hr>
                            <form th:method="post" action="/orders/">

                            </form>
                            <div th:id="product_composition_last">
                                <ul th:id="add_option_area"></ul>
                            </div>
                            <div th:id="total_pr" class="mb-4">
                            </div>
                            <div class="btn-group" role="group">
                                <a type="button" id="basket" class="btn btn-outline-dark">장바구니 담기</a>
                                <a type="button" id="purchase" class="btn btn-outline-dark">구매하기</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<hr>
<div class="container">
    <nav class="nav nav-pills nav-justified sticky-top bg-white">
        <a class="nav-item nav-link text-dark" href="#contents"><h3>상품정보</h3></a>
        <a class="nav-item nav-link text-dark" href="#review"><h3>상품리뷰</h3></a>
        <a class="nav-item nav-link text-dark" href="#qna"><h3>Q&A</h3></a>
        <a class="nav-item nav-link text-dark" href="#sellerInfo"><h3>판매자정보</h3></a>
    </nav>
    <div th:id="contents">
        <p th:utext="${product.contents}"></p>
    </div>
    <div class="mt-5" th:id="review">
        <h4>전체리뷰</h4>
        <hr>
        <ul>
            <li>
                <p>와우 좋아요!</p>
            </li>
        </ul>
    </div>
    <div class="mt-5" th:id="qna">
        <table class="mt-3 table">
           <thead class="thead-light">
               <tr>
                   <th>문의유형</th>
                   <th>문의/답변</th>
                   <th>작성자</th>
                   <th>작성일</th>
               </tr>
           </thead>
        </table>
    </div>
    <div class="mt-5" th:id="sellerInfo">
        <h4>반품/교환 정보</h4>
        <table class="mt-3 table table">
            <tr>
                <th>
                    판매자명
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    고객문의 대표번호
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환 배송비
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환지 주소
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환 안내
                </th>
                <td>

                </td>
            </tr>
            <tr>
                <th>
                    반품/교환지 기준
                </th>
                <td>

                </td>
            </tr>
        </table>
    </div>
</div>
</body>
<script th:inline="javascript">

    var optionArray = new Array();

    $(document).on('change',"#product_options",() => {

        let id = $("#product_options option").index($("#product_options option:selected"));

        if(optionArray.indexOf(id) !== -1) {
            alert('이미 선택되었습니다.');
            $("#product_options option:first").prop("selected",true);
            return;
        }
        optionArray.push(id);

        let price = $("#product_options option:selected").val();
        let name = $("#product_options option:selected").text();

        var optionUl = document.getElementById('add_option_area');
        var optionLi = document.createElement("li");
        optionLi.setAttribute('class','card mb-3');
        optionLi.setAttribute('data-prdno',id);
        optionLi.innerHTML =
            '<div class="card-body">\n' +
            '    <h5 class="card-title">'+name+'</h5>\n' +
            '<div class="row">\n' +
            '  <div class="col-4">\n' +
            '    <div class="input-group">\n' +
            '      <div class="input-group-prepend">\n' +
            '        <button type="button" class="btn btn-outline-dark btn-sm" id="subtractOption">-</button>\n' +
            '      </div>\n' +
            '      <input type="text" id="cuid_'+id+'" class="form-control text-center" value="1">\n' +
            '      <div class="input-group-append">\n' +
            '        <button type="button" class="btn btn-outline-dark btn-sm" id="plusOption">+</button>\n' +
            '      </div>\n' +
            '    </div>\n' +
            '  </div>\n' +
            '<div class="col-6">\n' +
            '    <p class="card-text text-right"><strong class="mr-1">'+numberWithCommas(price)+'</strong>원</p>\n' +
            '</div>\n' +
            '<div class="col-1">\n' +
            ' <button type="button" class="btn btn-secondary btn-sm" id="cancelProduct">x</button>\n' +
            '</div>\n' +
            '  </div>\n' +
            '</div>';

        optionUl.appendChild(optionLi);


        $("#product_options option:first").prop("selected",true);
        getSumPrice();

    });


    function getSumPrice() {
        var pricePrint = document.getElementById("total_pr");
        var wholePrice = numberWithCommas(getWholePrice());
        if(!document.getElementById("total_price")) {
            pricePrint.innerHTML =
                '<hr>\n' +
                '<div class="row justify-content-between" id="total_price">\n' +
                '<strong class="col-4">총 합계 금액</strong>\n' +
                '<span class="col-5 row">\n' +
                '<h4 class="text-danger  mr-1" id="ui_total_price">'+wholePrice+'</h4>\n' +
                '원\n' +
                '</span>\n' +
                '</div>\n' +
                '<hr>';
        } else {
            document.getElementById("ui_total_price").textContent = wholePrice;
        }
    }

    function changeButtonValue(e,fuc) {
        var button = e.target;
        var valueButton = button.parentElement.parentElement.getElementsByTagName('input').item(0);
        var value = parseInt(valueButton.value);


        priceTag = button.parentElement.parentElement.parentElement.nextElementSibling.getElementsByTagName('strong').item(0);

        var attributeId = valueButton.getAttribute('id').charAt(5);
        var eachPrice = document.getElementById('product_options')[attributeId].value;

        if(fuc === "sub") {
            if( value > 1) {
                valueButton.value = value - 1;
                priceTag.textContent = numberWithCommas(eachPrice * (value-1));
                getSumPrice();
            }
        } else if (fuc === "add") {
            valueButton.value = value + 1;
            priceTag.textContent = numberWithCommas(eachPrice * (value+1));
            getSumPrice();
        } else if (fuc === "change") {
            priceTag.textContent = eachPrice * value;
            getSumPrice();
        }
    }

    $(document).on('click',"#subtractOption",(e) => {
        changeButtonValue(e,"sub");

    });

    $(document).on('click',"#plusOption",(e) => {
        changeButtonValue(e,"add");
    });

    $(document).on('change',"#cuid_",(e) => {
        changeButtonValue(e,"change");
    });

    $(document).on('click',"#cancelProduct",(e) =>{
        var button = e.target;
        var parent = button.parentElement.parentElement.parentElement.parentElement;
        var parentId = parseInt(parent.getAttribute('data-prdno'));
        parent.remove();
        getSumPrice(parseInt(button.parentElement.parentElement.getElementsByTagName("strong").item(0).textContent) * -1);
        var number = optionArray.indexOf(parentId);
        optionArray.splice(number,1);

        if(optionArray.length === 0) {
            document.getElementById("total_pr").innerText = '';
        }
    });
</script>
<script th:inline="javascript">

    $(document).ready(function() {
        var formObj = $("form[role='form']");
        var productId = [[${product.productId}]];

        $().on("click","#basket",function() {

        });

        $(document).on("click","#purchase",function(e) {

            var orderItemJson = setOrderItemJson();
            document.getElementById("orderItemJson").setAttribute('value',JSON.stringify(orderItemJson));
            console.log(document.getElementById("orderItemJson").value);
            formObj.attr("action","/orders/orderSheet");
            formObj.attr("method","post");
            formObj.submit();
        });

    });

    function setOrderItemJson() {
        var optionItems = document.getElementById('add_option_area').getElementsByTagName('li');
        var Optionlength = optionItems.length;
        var orderItems = [];
        var temp = new Array();
        for(var i = 0; i < Optionlength; i++) {
            var id = optionItems[i].getAttribute('data-prdno');
            var price = parseInt(RemoveCommas(optionItems[i].getElementsByTagName('strong').item(0).textContent));
            var count = parseInt(optionItems[i].getElementsByTagName('input').item(0).value);
            var orderItem = {
                productOption : {
                    optionId : id,
                },
                price : price,
                count : count
            };
            temp[id] = orderItem;
        }
        for(var i = 0; i < temp.length; i++) {
            if(temp[i] !== undefined) {
                orderItems.push(temp[i]);
            }
        }
        return orderItems;
    }

    function getWholePrice() {
        var optionItems = document.getElementById("add_option_area").getElementsByTagName("li");
        var length = optionItems.length;
        var whole_price = 0;
        for(var i = 0; i < length; i++) {
            if(optionItems[i] !== null) {
                var price = parseInt(RemoveCommas(optionItems[i].getElementsByTagName('strong').item(0).textContent));
                whole_price += price;
            }
        }
        return whole_price;
    }

    function getWholeCount() {
        var optionItems = document.getElementById("add_option_area").getElementsByTagName("li");
        var length = optionItems.length;
        var whole_count = 0;
        for(var i = 0; i < length; i++) {
            if(optionItems[i] !== null) {
                var count = parseInt(optionItems[i].getElementsByTagName('input').item(0).value);
                whole_count += count;
            }
        }
        return whole_count;
    }

    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function RemoveCommas(x) {
        return x.toString().replace(/,/gi,"")
    }
</script>
</html>